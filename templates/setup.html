<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revax AI - Setup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="setup-page">
    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Top Box (1/3) -->
        <div class="top-box">
            <div class="setup-inputs">
                <div class="input-group">
                    <label>Client name:</label>
                    <input type="text" class="setup-input" id="client_name" placeholder="Client name">
                </div>
                <div class="input-group">
                    <label>Client location:</label>
                    <input type="text" class="setup-input" id="client_location" placeholder="Client location">
                </div>
                <div class="input-group">
                    <label>Target name:</label>
                    <input type="text" class="setup-input" id="target_name" placeholder="Target name">
                </div>
                <div class="input-group">
                    <label>Target location:</label>
                    <input type="text" class="setup-input" id="target_location" placeholder="Target location">
                </div>
                <div class="input-group">
                    <label>Lead partner:</label>
                    <input type="text" class="setup-input" id="lead_partner" placeholder="Lead partner">
                </div>
                <button class="setup-submit" id="setup-submit">Submit</button>
            </div>
        </div>

        <!-- Bottom Box (2/3) -->
        <div class="bottom-box">
            <!-- Empty for now -->
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="response_box_top" class="chat-top"></div>
    <div id="response_box_bottom" class="chat-bottom"></div>

    <form onsubmit="sendUserInput(event)" class="input-form">
        <div class="input-container">
            <input type="text" id="user_input" name="user_input" placeholder="Talk to Revax" required>
            <button class="submit-button" type="submit">
                <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
            </button>
            <button type="button" class="reset-button" onclick="resetConversation()">
                <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <polyline points="23 20 23 14 17 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
            </button>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded and script initialized"); // Verify script is running
            
            // Get the submit button and add click listener directly
            const submitButton = document.querySelector('.setup-submit');
            if (submitButton) {
                console.log("Submit button found");
                submitButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("Submit button clicked");
                    handleSetupSubmit();
                });
            } else {
                console.error("Submit button not found");
            }
        });

        function appendMessage(type, content) {
            const responseBox = document.getElementById('response_box');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add(type + "-message");
            messageDiv.textContent = content;
            responseBox.appendChild(messageDiv);
            responseBox.scrollTop = responseBox.scrollHeight;
            return messageDiv;
        }

        function sendUserInput(event) {
            event.preventDefault();
            const userInput = document.getElementById('user_input').value;
            if (!userInput.trim()) return;

            const chatBox = document.getElementById('response_box_bottom');
            
            // Add user message to chat
            chatBox.innerHTML += `
                <div class="user-message">
                    <p>${userInput}</p>
                </div>
            `;

            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-message';
            loadingDiv.textContent = 'Thinking...';
            chatBox.appendChild(loadingDiv);
            
            // Scroll to bottom
            chatBox.scrollTop = chatBox.scrollHeight;

            // Clear input
            document.getElementById('user_input').value = '';

            // Send to backend
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userInput,
                    session_id: getCurrentSessionId()
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading indicator
                loadingDiv.remove();
                
                // Add AI response
                chatBox.innerHTML += `
                    <div class="ai-message">
                        <p>${data.message}</p>
                    </div>
                `;
                
                // Scroll to bottom
                chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch(error => {
                loadingDiv.remove();
                chatBox.innerHTML += `
                    <div class="error-message">
                        <p>Error: ${error}</p>
                    </div>
                `;
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function getCurrentSessionId() {
            let sessionId = localStorage.getItem('chat_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now();
                localStorage.setItem('chat_session_id', sessionId);
            }
            return sessionId;
        }

        function resetConversation() {
            const sessionId = getCurrentSessionId();
            
            fetch('/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: sessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('response_box').innerHTML = '';
                    localStorage.removeItem('chat_session_id');
                    getCurrentSessionId();
                    document.getElementById('user_input').value = '';
                    appendMessage('assistant', 'Conversation has been reset. How can I help you?');
                } else {
                    console.error('Reset failed:', data.message);
                    appendMessage('assistant', 'Failed to reset conversation. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                appendMessage('assistant', 'Error resetting conversation. Please try again.');
            });
        }

        function handleSetupSubmit() {
            const setupData = {
                client_name: document.getElementById('client_name').value,
                client_location: document.getElementById('client_location').value,
                target_name: document.getElementById('target_name').value,
                target_location: document.getElementById('target_location').value,
                lead_partner: document.getElementById('lead_partner').value
            };

            fetch('/store-setup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(setupData)
            })
            .then(response => response.json())
            .then(data => {
                const bottomBox = document.querySelector('.bottom-box');
                
                // Store setup data globally for analysis
                window.currentSetupData = setupData;
                window.searchResults = data.search_results;

                // Update search results
                if (data.search_results && data.search_results.length > 0) {
                    const searchResults = data.search_results.map(result => {
                        console.log("Processing result:", result); // Debug log
                        
                        const pages = result.pages.map(page => `
                            <div class="page-info">
                                <span>Slide ${page.slide_number}</span>
                                <span>${(page.similarity * 100).toFixed(1)}%</span>
                            </div>
                        `).join('');

                        const safeFileName = result.file_name.replace(/[^a-zA-Z0-9]/g, '_'); // Create safe ID
                        
                        return `
                            <div class="result-group">
                                <div class="result-card">
                                    <div class="file-info">
                                        <span class="filename">${result.file_name}</span>
                                        <span class="match">${(result.overall_similarity * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="pages-container">
                                        ${pages}
                                    </div>
                                </div>
                                <div class="filename-box">
                                    <img src="" alt="Loading PDF preview..." class="document-preview" id="preview_${safeFileName}">
                                </div>
                            </div>
                        `;
                    }).join('');

                    // After adding results to DOM, fetch previews
                    data.search_results.forEach(result => {
                        console.log("Original file_name:", result.file_name); // Log original filename
                        
                        const safeFileName = result.file_name.replace(/[^a-zA-Z0-9]/g, '_');
                        console.log("Safe file_name:", safeFileName); // Log safe filename
                        
                        // Use the simplified filename format with explicit transformation steps
                        let filename = result.file_name;
                        filename = filename.replace(" copy", "");
                        filename = filename.replace(/ /g, "_");
                        filename = filename + ".pdf";  // Ensure .pdf extension
                        
                        console.log("Final filename for fetch:", filename); // Log final filename
                        console.log("Full fetch URL:", `/get_pdf_page/${encodeURIComponent(filename)}/0`); // Log full URL
                        
                        fetch(`/get_pdf_page/${encodeURIComponent(filename)}/0`)
                            .then(response => {
                                console.log("Response status:", response.status); // Log response status
                                console.log("Response headers:", response.headers); // Log response headers
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log("Received data:", data); // Log received data
                                if (data.image) {
                                    const img = document.getElementById(`preview_${safeFileName}`);
                                    if (img) {
                                        img.src = `data:image/png;base64,${data.image}`;
                                    } else {
                                        console.error("Image element not found:", `preview_${safeFileName}`);
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error loading PDF preview:', error);
                                const img = document.getElementById(`preview_${safeFileName}`);
                                if (img) {
                                    img.alt = "Error loading preview";
                                }
                            });
                    });

                    bottomBox.innerHTML = `
                        <div class="search-results">
                            ${searchResults}
                        </div>
                        <button id="analyzeButton" class="analyze-button" onclick="handleAnalysis()">
                            Analyze Results
                        </button>
                    `;
                } else {
                    bottomBox.innerHTML = '<div class="search-results">No results found</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                bottomBox.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            });
        }

        function handleAnalysis() {
            const analyzeButton = document.getElementById('analyzeButton');
            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Analyzing...';

            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    setup_data: window.currentSetupData,
                    search_results: window.searchResults
                })
            })
            .then(response => response.json())
            .then(data => {
                const topBox = document.getElementById('response_box_top');
                if (data.analysis_results) {
                    topBox.innerHTML = `<div class="analysis-results">${data.analysis_results}</div>`;
                }
                analyzeButton.textContent = 'Analysis Complete';
            })
            .catch(error => {
                console.error('Analysis error:', error);
                analyzeButton.textContent = 'Analysis Failed';
                const topBox = document.getElementById('response_box_top');
                topBox.innerHTML = `<div class="error">Analysis Error: ${error.message}</div>`;
            });
        }
    </script>

    <style>
        .result-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 0.4rem;
            padding: 0.4rem;
            font-size: 0.8em;
        }

        .file-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 0.2rem;
            padding-bottom: 0.2rem;
        }

        .filename {
            color: #495057;
            font-weight: bold;
            font-size: 0.9em;
        }

        .match {
            color: #28a745;
            font-size: 0.9em;
        }

        .page-info {
            display: flex;
            justify-content: space-between;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            margin-bottom: 0.2rem;
            padding: 0.2rem 0.4rem;
            color: #6c757d;
            font-size: 0.85em;
        }

        .pages-container {
            margin-top: 0.2rem;
        }

        .error {
            color: #dc3545;
            padding: 1rem;
            background: #f8d7da;
            border-radius: 4px;
        }

        .analyze-button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .analyze-button:hover {
            background-color: #218838;
        }

        .analyze-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</body>
</html> 